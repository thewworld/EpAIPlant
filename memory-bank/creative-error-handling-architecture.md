# é”™è¯¯å¤„ç†ä¸é‡è¯•æœºåˆ¶æ¶æ„è®¾è®¡

ğŸ¨ğŸ¨ğŸ¨ ENTERING CREATIVE PHASE: ARCHITECTURE DESIGN ğŸ¨ğŸ¨ğŸ¨

## é—®é¢˜é™ˆè¿°

EPAIå¹³å°å½“å‰åœ¨ä¸Dify APIå’ŒOpenAI APIäº¤äº’æ—¶ç¼ºä¹å¥å£®çš„é”™è¯¯å¤„ç†å’Œæ•…éšœæ¢å¤æœºåˆ¶ã€‚è¿™å¯¼è‡´åœ¨ç½‘ç»œä¸ç¨³å®šæˆ–å¤–éƒ¨æœåŠ¡æš‚æ—¶ä¸å¯ç”¨æ—¶ï¼Œåº”ç”¨æ€§èƒ½ä¸‹é™å¹¶å¯èƒ½å¯¼è‡´ç”¨æˆ·ä½“éªŒä¸­æ–­ã€‚ç‰¹åˆ«æ˜¯ï¼Œæµå¼å“åº”å¤„ç†ä¸­çš„é”™è¯¯å¯èƒ½å¯¼è‡´æ•°æ®ä¸å®Œæ•´æˆ–è¿æ¥æ–­å¼€ï¼Œè€Œæ²¡æœ‰é€‚å½“çš„é‡è¯•æœºåˆ¶ã€‚

### å…³é”®éœ€æ±‚ï¼š

1. æä¾›ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œé€‚ç”¨äºæ‰€æœ‰å¤–éƒ¨APIè°ƒç”¨
2. å®ç°æ™ºèƒ½é‡è¯•ç­–ç•¥ï¼Œèƒ½å¤ŸåŒºåˆ†ä¸´æ—¶å’Œæ°¸ä¹…æ€§æ•…éšœ
3. ç¡®ä¿æµå¼å“åº”ä¸­çš„é”™è¯¯èƒ½è¢«ä¼˜é›…å¤„ç†ï¼Œé¿å…ç”¨æˆ·ä½“éªŒä¸­æ–­
4. æä¾›è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œç›‘æ§ï¼Œä¾¿äºé—®é¢˜è¯Šæ–­
5. ä¿æŒä»£ç å¯ç»´æŠ¤æ€§ï¼Œé¿å…é”™è¯¯å¤„ç†é€»è¾‘åˆ†æ•£åœ¨æ•´ä¸ªä»£ç åº“ä¸­

## æ¶æ„é€‰é¡¹åˆ†æ

### é€‰é¡¹1ï¼šé›†ä¸­å¼é”™è¯¯å¤„ç†æœåŠ¡

**æè¿°**ï¼šåˆ›å»ºä¸€ä¸ªä¸“é—¨çš„é”™è¯¯å¤„ç†æœåŠ¡ï¼Œæ‰€æœ‰å¤–éƒ¨APIè°ƒç”¨éƒ½é€šè¿‡æ­¤æœåŠ¡è¿›è¡Œä»£ç†ï¼Œç»Ÿä¸€å¤„ç†é”™è¯¯å’Œé‡è¯•é€»è¾‘ã€‚

**ä¼˜ç‚¹**ï¼š
- é”™è¯¯å¤„ç†é€»è¾‘å®Œå…¨é›†ä¸­åŒ–ï¼Œä¾¿äºç»´æŠ¤
- å¯ä»¥ä¸ºæ‰€æœ‰æœåŠ¡æä¾›ä¸€è‡´çš„é”™è¯¯å¤„ç†ç­–ç•¥
- ä¾¿äºå®ç°å…¨å±€çš„ç›‘æ§å’Œæ—¥å¿—è®°å½•
- å¯ç‹¬ç«‹æ‰©å±•å’Œä¼˜åŒ–é”™è¯¯å¤„ç†æœåŠ¡

**ç¼ºç‚¹**ï¼š
- å¼•å…¥æ–°çš„æœåŠ¡å¢åŠ ç³»ç»Ÿå¤æ‚æ€§
- å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Œç‰¹åˆ«æ˜¯å¯¹äºé«˜é¢‘APIè°ƒç”¨
- ä¸ºæµå¼å“åº”æ·»åŠ é¢å¤–ç½‘ç»œå±‚å¯èƒ½å¢åŠ å»¶è¿Ÿ
- å®ç°å¤æ‚åº¦è¾ƒé«˜ï¼Œéœ€è¦è€ƒè™‘æœåŠ¡æœ¬èº«çš„é«˜å¯ç”¨æ€§

**æŠ€æœ¯å¥‘åˆåº¦**ï¼šä¸­
**å¤æ‚åº¦**ï¼šé«˜
**å¯æ‰©å±•æ€§**ï¼šé«˜

### é€‰é¡¹2ï¼šAOPåˆ‡é¢å¼é”™è¯¯å¤„ç†

**æè¿°**ï¼šä½¿ç”¨Spring AOPå®ç°æ¨ªåˆ‡å…³æ³¨ç‚¹çš„é”™è¯¯å¤„ç†ï¼Œé€šè¿‡æ³¨è§£å’Œåˆ‡é¢æ‹¦æˆªå¤–éƒ¨APIè°ƒç”¨å¹¶åº”ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†é€»è¾‘ã€‚

**ä¼˜ç‚¹**ï¼š
- ä¸Springç”Ÿæ€ç³»ç»Ÿæ— ç¼é›†æˆ
- ä¸éœ€è¦ä¿®æ”¹ç°æœ‰æœåŠ¡ä»£ç ç»“æ„
- é”™è¯¯å¤„ç†é€»è¾‘é›†ä¸­åœ¨åˆ‡é¢ä¸­ï¼Œæ˜“äºç»´æŠ¤
- å¯ä»¥æ ¹æ®ä¸åŒæœåŠ¡å®šåˆ¶ä¸åŒçš„é”™è¯¯å¤„ç†ç­–ç•¥

**ç¼ºç‚¹**ï¼š
- å¯¹æµå¼å¤„ç†å’Œreactiveç¼–ç¨‹æ¨¡å‹çš„æ”¯æŒæœ‰é™
- å¯èƒ½å¯¼è‡´"é­”æ³•ä»£ç "ï¼Œé™ä½ä»£ç å¯è¯»æ€§
- æŸäº›å¤æ‚é”™è¯¯æƒ…å†µå¯èƒ½éš¾ä»¥åœ¨åˆ‡é¢ä¸­å¤„ç†
- éœ€è¦ä»”ç»†è®¾è®¡ä»¥é¿å…åˆ‡é¢é—´çš„ç›¸äº’å¹²æ‰°

**æŠ€æœ¯å¥‘åˆåº¦**ï¼šé«˜
**å¤æ‚åº¦**ï¼šä¸­
**å¯æ‰©å±•æ€§**ï¼šä¸­

### é€‰é¡¹3ï¼šResilience4jé›†æˆæ–¹æ¡ˆ

**æè¿°**ï¼šé›†æˆResilience4jåº“ï¼Œå®ç°æ–­è·¯å™¨ã€é‡è¯•ã€é™æµã€è¶…æ—¶ç­‰å¼¹æ€§åŠŸèƒ½ï¼Œå¹¶ä¸ºå„ä¸ªå¤–éƒ¨æœåŠ¡è°ƒç”¨åŒ…è£…è¿™äº›å¼¹æ€§æ¨¡å¼ã€‚

**ä¼˜ç‚¹**ï¼š
- ä½¿ç”¨æˆç†Ÿçš„å¼¹æ€§ç¼–ç¨‹åº“ï¼Œä¸éœ€è¦ä»é›¶å¼€å§‹å®ç°
- æä¾›ä¸°å¯Œçš„å¼¹æ€§æ¨¡å¼ï¼šæ–­è·¯å™¨ã€é‡è¯•ã€é™æµã€è¶…æ—¶ç­‰
- æ”¯æŒå£°æ˜å¼æ³¨è§£å’Œç¼–ç¨‹å¼API
- æä¾›è¯¦ç»†çš„æŒ‡æ ‡ç›‘æ§å’Œäº‹ä»¶å‘å¸ƒ
- ä¸Spring Bootå’ŒSpring Cloudç”Ÿæ€ç³»ç»Ÿé›†æˆè‰¯å¥½

**ç¼ºç‚¹**ï¼š
- éœ€è¦ä¸ºæ¯ä¸ªå¤–éƒ¨æœåŠ¡è°ƒç”¨æ·»åŠ é¢å¤–çš„é…ç½®å’Œä»£ç 
- å¯¹äºæµå¼å“åº”å¤„ç†ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
- éœ€è¦å›¢é˜Ÿå­¦ä¹ æ–°åº“çš„ä½¿ç”¨æ–¹æ³•
- é…ç½®ä¸å½“å¯èƒ½å¯¼è‡´æ„å¤–çš„è¡Œä¸º

**æŠ€æœ¯å¥‘åˆåº¦**ï¼šé«˜
**å¤æ‚åº¦**ï¼šä¸­
**å¯æ‰©å±•æ€§**ï¼šé«˜

## å†³ç­–

**é€‰æ‹©æ–¹æ¡ˆ**ï¼šé€‰é¡¹3 - Resilience4jé›†æˆæ–¹æ¡ˆ

**ç†ç”±**ï¼š
1. Resilience4jæä¾›äº†æˆç†Ÿã€å…¨é¢çš„å¼¹æ€§ç¼–ç¨‹åŠŸèƒ½ï¼Œèƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„æ‰€æœ‰é”™è¯¯å¤„ç†å’Œé‡è¯•éœ€æ±‚ã€‚
2. å®ƒä¸Spring Bootå’ŒSpring Cloudç”Ÿæ€ç³»ç»Ÿé›†æˆè‰¯å¥½ï¼Œç¬¦åˆæˆ‘ä»¬çš„æŠ€æœ¯æ ˆã€‚
3. æä¾›äº†å£°æ˜å¼å’Œç¼–ç¨‹å¼APIï¼Œå¯ä»¥çµæ´»åº”ç”¨äºä¸åŒåœºæ™¯ï¼ŒåŒ…æ‹¬æµå¼å“åº”å¤„ç†ã€‚
4. ç›¸æ¯”è‡ªå»ºæœåŠ¡ï¼Œä½¿ç”¨Resilience4jé™ä½äº†å®ç°å¤æ‚åº¦å’Œç»´æŠ¤æˆæœ¬ã€‚
5. è¯¥æ–¹æ¡ˆæä¾›äº†ä¸°å¯Œçš„ç›‘æ§æŒ‡æ ‡ï¼Œä¾¿äºé—®é¢˜è¯Šæ–­å’Œç³»ç»Ÿä¼˜åŒ–ã€‚

ğŸ¨ CREATIVE CHECKPOINT: æ¶æ„æ–¹æ¡ˆé€‰æ‹©å®Œæˆ

## å®ç°è®¾è®¡

### ç»„ä»¶ç»“æ„

```mermaid
graph TD
    API["APIæ§åˆ¶å™¨"] --> ErrorConfig["é”™è¯¯å¤„ç†é…ç½®"]
    API --> Service["æœåŠ¡å±‚"]
    Service --> ExternalClient["å¤–éƒ¨APIå®¢æˆ·ç«¯"]
    ExternalClient --> R4J["Resilience4jç»„ä»¶"]
    R4J --> Circuit["æ–­è·¯å™¨"]
    R4J --> Retry["é‡è¯•æœºåˆ¶"]
    R4J --> Timeout["è¶…æ—¶æ§åˆ¶"]
    R4J --> Bulkhead["éš”æ¿æ¨¡å¼"]
    R4J --> RateLimiter["é™æµå™¨"]
    ExternalClient --> DifyAPI["Dify API"]
    ExternalClient --> OpenAIAPI["OpenAI API"]
    R4J --> Metrics["ç›‘æ§æŒ‡æ ‡"]
    Metrics --> Actuator["Spring Actuator"]
```

### å…³é”®ç»„ä»¶

1. **ResilienceConfiguration**: é›†ä¸­é…ç½®æ–­è·¯å™¨ã€é‡è¯•ã€è¶…æ—¶ç­‰Resilience4jç»„ä»¶ã€‚
2. **ResilienceAspect**: AOPåˆ‡é¢ï¼Œç”¨äºåº”ç”¨Resilience4jåŠŸèƒ½åˆ°å¤–éƒ¨æœåŠ¡è°ƒç”¨ã€‚
3. **CustomExceptionHandler**: å…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼Œç»Ÿä¸€å¤„ç†å’Œè½¬æ¢å¼‚å¸¸ã€‚
4. **MetricsCollector**: æ”¶é›†å’Œå‘å¸ƒå¼¹æ€§æ“ä½œç›¸å…³çš„æŒ‡æ ‡ã€‚
5. **ReactiveResilience**: ä¸“é—¨ç”¨äºå¤„ç†reactiveå’Œæµå¼å“åº”çš„å¼¹æ€§æ¨¡å¼é€‚é…å™¨ã€‚

### é‡è¯•ç­–ç•¥è®¾è®¡

```mermaid
graph TD
    Error["APIé”™è¯¯"] --> Classify["é”™è¯¯åˆ†ç±»"]
    Classify -->|"ç½‘ç»œé”™è¯¯"| NetworkError["ç½‘ç»œé”™è¯¯"]
    Classify -->|"æœåŠ¡é”™è¯¯"| ServiceError["æœåŠ¡é”™è¯¯"]
    Classify -->|"è®¤è¯é”™è¯¯"| AuthError["è®¤è¯é”™è¯¯"]
    Classify -->|"èµ„æºé”™è¯¯"| ResourceError["èµ„æºé”™è¯¯"]
    
    NetworkError --> Retry1["æŒ‡æ•°é€€é¿é‡è¯•"]
    ServiceError --> Retry2["æœ‰é™æ¬¡æ•°é‡è¯•"]
    AuthError --> NoRetry["ä¸é‡è¯•"]
    ResourceError --> NoRetry
    
    Retry1 --> MaxAttempts["æœ€å¤§å°è¯•æ¬¡æ•°: 5"]
    Retry2 --> MaxAttempts2["æœ€å¤§å°è¯•æ¬¡æ•°: 3"]
    
    MaxAttempts & MaxAttempts2 --> Fallback["å¤±è´¥åå¤‡æ–¹æ¡ˆ"]
```

### æµå¼å“åº”å¤„ç†è®¾è®¡

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant API as APIæ§åˆ¶å™¨
    participant Service as æœåŠ¡å±‚
    participant Resilience as Resilience4j
    participant ExternalAPI as å¤–éƒ¨API
    
    Client->>API: è¯·æ±‚æµå¼å“åº”
    API->>Service: è½¬å‘è¯·æ±‚
    Service->>Resilience: åŒ…è£…è°ƒç”¨
    Resilience->>ExternalAPI: åˆå§‹è¿æ¥
    
    alt è¿æ¥æˆåŠŸ
        ExternalAPI-->>Resilience: æµå¼æ•°æ®å—1
        Resilience-->>Service: å¤„ç†æ•°æ®å—1
        Service-->>API: è½¬å‘æ•°æ®å—1
        API-->>Client: å‘é€æ•°æ®å—1
        
        ExternalAPI-->>Resilience: æµå¼æ•°æ®å—2
        Resilience-->>Service: å¤„ç†æ•°æ®å—2
        Service-->>API: è½¬å‘æ•°æ®å—2
        API-->>Client: å‘é€æ•°æ®å—2
    else è¿æ¥å¤±è´¥æˆ–ä¸­æ–­
        ExternalAPI--xResilience: è¿æ¥é”™è¯¯
        Resilience->>ExternalAPI: é‡è¯•è¿æ¥
        ExternalAPI-->>Resilience: é‡æ–°å»ºç«‹è¿æ¥
        Resilience-->>Service: æ¢å¤æµå¼å¤„ç†
        Service-->>API: æ¢å¤æ•°æ®æµ
        API-->>Client: ç»§ç»­å‘é€æ•°æ®
    end
    
    ExternalAPI-->>Resilience: æµå¼æ•°æ®å®Œæˆ
    Resilience-->>Service: å¤„ç†å®Œæˆ
    Service-->>API: æ ‡è®°å®Œæˆ
    API-->>Client: å…³é—­æµ
```

## å®ç°æŒ‡å—

1. **æ·»åŠ ä¾èµ–**:
   ```xml
   <dependency>
       <groupId>io.github.resilience4j</groupId>
       <artifactId>resilience4j-spring-boot2</artifactId>
       <version>1.7.0</version>
   </dependency>
   <dependency>
       <groupId>org.springframework.boot</groupId>
       <artifactId>spring-boot-starter-aop</artifactId>
   </dependency>
   <dependency>
       <groupId>org.springframework.boot</groupId>
       <artifactId>spring-boot-starter-actuator</artifactId>
   </dependency>
   ```

2. **é…ç½®Resilience4j**:
   ```yaml
   resilience4j:
     retry:
       instances:
         difyApiRetry:
           maxAttempts: 5
           waitDuration: 1s
           enableExponentialBackoff: true
           exponentialBackoffMultiplier: 2
           retryExceptions:
             - org.springframework.web.client.ResourceAccessException
             - java.net.SocketTimeoutException
         openAiApiRetry:
           maxAttempts: 3
           waitDuration: 2s
     circuitbreaker:
       instances:
         difyApiCircuitBreaker:
           slidingWindowSize: 10
           failureRateThreshold: 50
           waitDurationInOpenState: 10s
         openAiApiCircuitBreaker:
           slidingWindowSize: 10
           failureRateThreshold: 60
           waitDurationInOpenState: 20s
     bulkhead:
       instances:
         difyApiBulkhead:
           maxConcurrentCalls: 20
         openAiApiBulkhead:
           maxConcurrentCalls: 15
   ```

3. **ä¸ºæµå¼å“åº”å¼€å‘ç‰¹æ®Šå¤„ç†æœºåˆ¶**:
   ```java
   @Service
   public class ReactiveResilienceService {
       
       private final ReactiveCircuitBreaker circuitBreaker;
       private final ReactiveRetry retry;
       
       // æ„é€ å‡½æ•°æ³¨å…¥æ–­è·¯å™¨å’Œé‡è¯•ç»„ä»¶
       
       public Flux<String> executeWithResilience(Flux<String> streamingOperation) {
           return retry.executeFlux(
               circuitBreaker.executeFlux(streamingOperation)
                   .onErrorResume(this::handleStreamingError)
           );
       }
       
       private Flux<String> handleStreamingError(Throwable error) {
           // é”™è¯¯å¤„ç†å’Œæ¢å¤é€»è¾‘
           if (isRecoverable(error)) {
               return Flux.empty().delayElements(Duration.ofMillis(500))
                   .mergeWith(Flux.just("[[æ¢å¤è¿æ¥ä¸­...]]"));
           } else {
               return Flux.error(new StreamingException("æµå¼å¤„ç†é”™è¯¯", error));
           }
       }
   }
   ```

4. **åˆ›å»ºç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†å™¨**:
   ```java
   @ControllerAdvice
   public class GlobalExceptionHandler {
       
       @ExceptionHandler(CircuitBreakerOpenException.class)
       public ResponseEntity<ApiError> handleCircuitBreakerOpenException(CircuitBreakerOpenException ex) {
           ApiError error = new ApiError("SERVICE_UNAVAILABLE", "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•", HttpStatus.SERVICE_UNAVAILABLE.value());
           return new ResponseEntity<>(error, HttpStatus.SERVICE_UNAVAILABLE);
       }
       
       @ExceptionHandler(BulkheadFullException.class)
       public ResponseEntity<ApiError> handleBulkheadFullException(BulkheadFullException ex) {
           ApiError error = new ApiError("TOO_MANY_REQUESTS", "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•", HttpStatus.TOO_MANY_REQUESTS.value());
           return new ResponseEntity<>(error, HttpStatus.TOO_MANY_REQUESTS);
       }
       
       // å…¶ä»–å¼‚å¸¸å¤„ç†æ–¹æ³•
   }
   ```

5. **æœåŠ¡å±‚é›†æˆResilience4j**:
   ```java
   @Service
   public class DifyChatServiceImpl implements DifyChatService {
       
       @Retry(name = "difyApiRetry")
       @CircuitBreaker(name = "difyApiCircuitBreaker")
       @Bulkhead(name = "difyApiBulkhead")
       @Override
       public Map<String, Object> sendChatMessageBlock(String query, Map<String, Object> inputs, 
                                                     String user, String conversationId, 
                                                     List<Map<String, Object>> files, 
                                                     Boolean autoGenerateName, String apiKey) {
           // åŸæœ‰å®ç°é€»è¾‘
       }
       
       // æµå¼å“åº”å¤„ç†éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨æ³¨è§£
       @Override
       public void sendChatMessageStream(String query, Map<String, Object> inputs, 
                                       String user, String conversationId, 
                                       List<Map<String, Object>> files, Boolean autoGenerateName, 
                                       String apiKey, SseEmitter sseEmitter) {
           reactiveResilienceService.executeWithResilience(
               webClient.post()
                   .uri("/chat-messages")
                   .header(HttpHeaders.AUTHORIZATION, "Bearer " + apiKey)
                   // ... å…¶ä»–è®¾ç½®
                   .retrieve()
                   .bodyToFlux(String.class)
           ).subscribe(
               dataLine -> {
                   try {
                       Map<String, Object> eventMap = objectMapper.readValue(dataLine, Map.class);
                       sseEmitter.send(SseEmitter.event().data(eventMap));
                   } catch (IOException e) {
                       // å¤„ç†é”™è¯¯
                   }
               },
               error -> {
                   // å¤„ç†é”™è¯¯ï¼Œå°è¯•æ¢å¤æˆ–ä¼˜é›…å…³é—­
                   try {
                       sseEmitter.send(SseEmitter.event().data(Map.of("event", "error", 
                           "error", Map.of("message", "å¤„ç†å‡ºé”™ï¼Œæ­£åœ¨å°è¯•æ¢å¤..."))));
                   } catch (IOException e) {
                       // è®°å½•æ— æ³•å‘é€é”™è¯¯ä¿¡æ¯
                   }
                   sseEmitter.completeWithError(error);
               },
               () -> sseEmitter.complete()
           );
       }
   }
   ```

## éªŒè¯å’Œæ£€æŸ¥ç‚¹

âœ“ **æ¶æ„è®¾è®¡éªŒè¯**
- [x] æ‰€æœ‰ç³»ç»Ÿéœ€æ±‚å·²è¦†ç›–
- [x] ç»„ä»¶èŒè´£å·²æ˜ç¡®å®šä¹‰
- [x] æ¥å£å·²æ˜ç¡®æŒ‡å®š
- [x] æ•°æ®æµå·²è®°å½•
- [x] å·²è§£å†³å®‰å…¨è€ƒè™‘
- [x] ç¬¦åˆå¯æ‰©å±•æ€§éœ€æ±‚
- [x] ç¬¦åˆæ€§èƒ½éœ€æ±‚
- [x] å·²å®šä¹‰ç»´æŠ¤æ–¹æ³•

âœ“ **å®æ–½å‡†å¤‡å°±ç»ª**
- [x] å·²è¯†åˆ«æ‰€æœ‰ç»„ä»¶
- [x] å·²æ˜ å°„ä¾èµ–å…³ç³»
- [x] å·²è®°å½•æŠ€æœ¯é™åˆ¶
- [x] å·²å®Œæˆé£é™©è¯„ä¼°
- [x] å·²å®šä¹‰èµ„æºéœ€æ±‚
- [x] å·²æä¾›æ—¶é—´ä¼°è®¡

ğŸ¨ğŸ¨ğŸ¨ EXITING CREATIVE PHASE - DECISION MADE ğŸ¨ğŸ¨ğŸ¨ 